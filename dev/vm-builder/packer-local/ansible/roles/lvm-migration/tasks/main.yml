---
# Install LVM migration script and systemd service
# LOCAL-ONLY: This role is specific to local KVM deployment
# The migration will run on first boot after deployment

- name: Check if LVM migration already completed
  stat:
    path: /var/lib/lvm-migrate-done
  register: lvm_done
  tags:
    - lvm
    - lvm-migration

- name: Setup LVM migration for first boot
  when: not lvm_done.stat.exists
  tags:
    - lvm
    - lvm-migration
  block:
    - name: Copy LVM migration script
      copy:
        src: lvm-migrate.sh
        dest: /root/lvm-migrate.sh
        mode: '0755'
        owner: root
        group: root

    - name: Copy systemd service for LVM migration
      copy:
        src: lvm-migrate.service
        dest: /etc/systemd/system/lvm-migrate.service
        mode: '0644'
        owner: root
        group: root

    - name: Enable LVM migration service for first boot
      systemd:
        name: lvm-migrate.service
        enabled: yes
        daemon_reload: yes

    - name: Inform about LVM migration
      debug:
        msg: "LVM migration will run automatically on first boot after deployment"
